{% extends 'base.html.twig' %}

{% block title %}Réservation - GNUT 06
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
/* ✅ Focus visible obligatoire WCAG 2.1 AA */
.btn-outline-gradient:focus,
.icon-link:focus,
.carousel-control-prev:focus,
.carousel-control-next:focus,
.carousel-indicators button:focus,
.card:focus {
    outline: 3px solid #F86CF8 !important;
    outline-offset: 2px !important;
    box-shadow: 0 0 0 3px rgba(248, 108, 248, 0.5) !important;
}

/* ✅ Amélioration du contraste pour la lisibilité */
.text {
    color: #ffffff !important;
}

.card-text {
    color: #e0e0e0 !important;
    line-height: 1.6 !important;
}

/* ✅ Zone de clic minimale pour accessibilité tactile */
.icon-link,
.btn-outline-gradient {
    min-height: 44px !important;
    min-width: 44px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem !important; /* ✅ Espace entre icône et texte */
}

/* ✅ Espacement spécifique pour les icônes dans les boutons */
.btn-outline-gradient i {
    margin-right: 0.5rem !important;
}

/* Corrections pour les contrôles du carousel */
.carousel-control-prev,
.carousel-control-next {
    width: 5%;
    top: 30%;
    height: 40%;
    z-index: 5;
}

/* Assurer que les liens et boutons des cartes sont au-dessus */
.card {
    position: relative;
    z-index: 10;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover,
.card:focus-within {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(248, 108, 248, 0.2);
}

.card-body {
    position: relative;
    z-index: 15;
}

/* Assurer que les liens sont cliquables */
.icon-link,
.btn-outline-gradient {
    position: relative;
    z-index: 20;
}

/* Conteneur carousel avec la même couleur que bg-main */
.carousel-container {
    background: var(--Color-Background, linear-gradient(180deg, #010208 16%, #010206 21%, #040008 25%, #010101 30%, #010101 34%, #010101 36%, #010101 100%));
    width: 100%;
    position: relative;
    padding: 0 60px;
    padding-bottom: 60px;
}

/* Alternative : Positionner les contrôles en dehors de la zone des cartes */
@media(min-width: 992px) {
    .carousel-control-prev {
        left: 10px;
    }

    .carousel-control-next {
        right: 10px;
    }
}

@media(max-width: 991px) {
    .carousel-container {
        padding: 0 20px 60px 20px;
    }
    
    .carousel-control-prev,
    .carousel-control-next {
        width: 3%;
        top: 35%;
        height: 30%;
    }
    
    .carousel-control-prev {
        left: 5px;
    }
    
    .carousel-control-next {
        right: 5px;
    }
}

@media(max-width: 768px) {
    .carousel-container {
        padding: 0 15px 60px 15px;
    }
    
    .carousel-control-prev,
    .carousel-control-next {
        width: 8%;
        top: 25%;
        height: 30%;
        z-index: 5;
    }
    
    .carousel-control-prev {
        left: 5px;
    }
    
    .carousel-control-next {
        right: 5px;
    }

    .card-body {
        padding: 1rem 0.75rem;
    }
}

@media(max-width: 576px) {
    .carousel-container {
        padding: 0 0 60px 0;
    }
    
    .carousel-control-prev,
    .carousel-control-next {
        display: none !important;
    }
}

/* Style pour les indicateurs */
.carousel-indicators {
    bottom: 10px;
    margin-bottom: 0;
    z-index: 25;
}

.carousel-indicators button {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin: 0 5px;
    background-color: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.8);
}

.carousel-indicators button.active {
    background-color: white;
}

/* Retirer la marge sur #evenements */
#evenements {
    margin: 0;
    width: 100%;
}

/* Assurer que le carousel a assez d'espace */
#evenements.pb-5 {
    padding-bottom: 0 !important;
}

/* ✅ Animation respectueuse des préférences utilisateur */
@media (prefers-reduced-motion: reduce) {
    .card,
    .carousel-item {
        transition: none !important;
        animation: none !important;
    }
}
</style>
{% endblock %}

{% block body %}
<!-- ✅ Main principal pour structure -->
<main role="main">

    <!-- ✅ Section Intro avec H1 principal -->
    <section class="bg-main w-100 d-flex justify-content-center pt-5 pb-5" 
             role="region" 
             aria-labelledby="main-title">
        <div class="container row align-items-center justify-content-center g-5">
            <header class="col-lg-6 col-12">
                <h1 id="main-title">Mondes Virtuels, Liens Réels : L'Inclusion à Portée de main</h1>
                <p class="text">Venez découvrir nos actions sur place !</p>
                <a href="{{ path('app_a_propos') }}" 
                   class="btn-neon text-white" 
                   aria-label="En savoir plus sur GNUT 06 et nos actions d'inclusion">
                    Découvrez GNUT 06
                </a>
            </header>

            <div class="col-lg-6 col-12">
                <figure>
                    <img src="{{ asset('images/webp/immersion-3.webp') }}" 
                         class="img-fluid" 
                         alt="Illustration d'une immersion dans un monde virtuel accessible pour l'inclusion numérique"
                         role="img">
                </figure>
            </div>
        </div>
    </section>

    <!-- ✅ Section Carousel avec structure WCAG complète -->
    <div class="carousel-container bg-main">
        <section id="evenements" 
                 class="carousel slide bg-main pb-5" 
                 data-bs-ride="false"
                 data-bs-interval="false"
                 role="region"
                 aria-label="Nos événements disponibles" 
                 aria-roledescription="carousel">

            <!-- ✅ Instructions complètes pour lecteurs d'écran -->
            <h2 class="visually-hidden">Nos événements disponibles</h2>
            <div class="visually-hidden" aria-live="polite" id="carousel-live-region">
                Carousel contenant {{ data_forms|length }} événements répartis en {{ (data_forms|length / 3)|round(0, 'ceil') }} groupes. 
                Utilisez les boutons suivant et précédent pour naviguer entre les groupes d'événements, 
                ou utilisez Tab pour accéder directement aux événements.
            </div>

            <div class="carousel-inner" role="listbox" aria-describedby="carousel-live-region">
                {% for group in data_forms|batch(3) %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}" 
                         role="group" 
                         aria-roledescription="slide" 
                         aria-label="Groupe d'événements {{ loop.index }} sur {{ (data_forms|length / 3)|round(0, 'ceil') }}"
                         id="carousel-slide-{{ loop.index0 }}">

                        <div class="container py-4">
                            <div class="row g-4 justify-content-center" role="list">

                                {% for item in group %}
                                    <article class="col-12 col-sm-6 col-lg-4 d-flex px-3 px-sm-2" 
                                             role="listitem" 
                                             aria-labelledby="event-title-{{ loop.parent.loop.index }}-{{ loop.index }}">

                                        <div class="card h-100 flex-fill" 
                                             tabindex="0"
                                             aria-describedby="event-desc-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                            <figure class="m-0">
                                                <img src="{{ asset(randomImage('/images/news/')) }}" 
                                                     class="card-img-top" 
                                                     alt="Illustration de l'événement {{ item.title }}"
                                                     role="img">
                                            </figure>

                                            <div class="card-body d-flex flex-column bg-main p-3">
                                                <h3 id="event-title-{{ loop.parent.loop.index }}-{{ loop.index }}" 
                                                    class="card-title text-center text text-white mb-3">
                                                    {{ item.title }}
                                                </h3>

                                                <p id="event-desc-{{ loop.parent.loop.index }}-{{ loop.index }}"
                                                   class="text-justify flex-grow-1 text mb-3" 
                                                   role="text">
                                                    {{ item.description|slice(0, 200) }}...
                                                </p>

                                                <div class="mt-auto">
                                                    <div class="mb-3">
                                                        <a class="icon-link icon-link-hover d-inline-block w-100 text-center py-2 text shadow-sm" 
                                                           href="{{ path('app_billetteries_detail', {'formType': item.formType, 'slug': item.formSlug}) }}" 
                                                           aria-label="En savoir plus sur l'événement {{ item.title }}"
                                                           aria-describedby="more-info-help-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                                            En savoir plus
                                                            <i class="bi bi-arrow-right" aria-hidden="true"></i>
                                                        </a>
                                                        <div id="more-info-help-{{ loop.parent.loop.index }}-{{ loop.index }}" class="visually-hidden">
                                                            Consulter les détails complets de cet événement
                                                        </div>
                                                    </div>

                                                    <div class="text-center mb-3">
                                                        <button class="btn-outline-gradient btn-sm text w-100 py-2" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#modal_{{ loop.parent.loop.index }}_{{ loop.index }}" 
                                                                aria-haspopup="dialog" 
                                                                aria-controls="modal_{{ loop.parent.loop.index }}_{{ loop.index }}"
                                                                aria-label="Ouvrir le formulaire de réservation pour {{ item.title }}"
                                                                aria-describedby="booking-help-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                                            <i class="bi bi-calendar-event-fill" aria-hidden="true"></i>
                                                            <span>Réserver</span>
                                                        </button>
                                                        <div id="booking-help-{{ loop.parent.loop.index }}-{{ loop.index }}" class="visually-hidden">
                                                            Ouvre une fenêtre modale avec le formulaire de réservation
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </article>

                                    <!-- ✅ Modal avec accessibilité complète -->
                                    <div class="modal fade modal-lg" 
                                         id="modal_{{ loop.parent.loop.index }}_{{ loop.index }}" 
                                         tabindex="-1" 
                                         role="dialog" 
                                         aria-labelledby="ModalLabel_{{ loop.parent.loop.index }}_{{ loop.index }}" 
                                         aria-modal="true" 
                                         aria-hidden="true"
                                         aria-describedby="modal-desc-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                        
                                        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                                            <div class="modal-content">
                                                <header class="modal-header">
                                                    <h2 class="modal-title fs-5" id="ModalLabel_{{ loop.parent.loop.index }}_{{ loop.index }}">
                                                        Réservation : {{ item.title }}
                                                    </h2>
                                                    <button type="button" 
                                                            class="btn-close" 
                                                            data-bs-dismiss="modal" 
                                                            aria-label="Fermer la fenêtre de réservation pour {{ item.title }}"></button>
                                                </header>

                                                <div class="modal-body" id="modal-desc-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                                    <div class="visually-hidden">
                                                        Formulaire de réservation pour {{ item.title }}. 
                                                        Utilisez Tab pour naviguer dans le formulaire.
                                                        Appuyez sur Échap pour fermer cette fenêtre.
                                                    </div>
                                                    <iframe id="haWidget_{{ loop.parent.loop.index }}_{{ loop.index }}" 
                                                            allowtransparency="true" 
                                                            scrolling="auto" 
                                                            title="Formulaire de réservation pour {{ item.title }}" 
                                                            src="{{ item.widgetFullUrl }}" 
                                                            style="width: 100%; min-height: 750px; border: none;"
                                                            aria-label="Formulaire interactif de réservation HelloAsso"
                                                            onload="this.focus()"></iframe>
                                                </div>

                                                <footer class="modal-footer">
                                                    <button type="button" 
                                                            class="btn-asso" 
                                                            data-bs-dismiss="modal"
                                                            aria-label="Fermer la fenêtre de réservation">
                                                        <i class="bi bi-x-circle" aria-hidden="true"></i>
                                                        Fermer
                                                    </button>
                                                </footer>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div role="status" aria-live="polite">
                        <div class="alert alert-info text-center" role="alert">
                            <i class="bi bi-info-circle" aria-hidden="true"></i>
                            <p class="mb-0">Aucun événement disponible pour le moment.</p>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- ✅ Indicateurs accessibles avec instructions -->
            {% if (data_forms|length / 3)|round(0, 'ceil') > 1 %}
                <div class="carousel-indicators d-md-none" 
                     role="tablist" 
                     aria-label="Navigation par groupes d'événements">
                    {% for group in data_forms|batch(3) %}
                        <button type="button" 
                                data-bs-target="#evenements" 
                                data-bs-slide-to="{{ loop.index0 }}" 
                                {% if loop.first %} class="active" aria-current="true" {% endif %}
                                role="tab"
                                aria-controls="carousel-slide-{{ loop.index0 }}"
                                aria-label="Afficher le groupe d'événements {{ loop.index }} sur {{ (data_forms|length / 3)|round(0, 'ceil') }}"></button>
                    {% endfor %}
                </div>

                <!-- ✅ Contrôles accessibles avec contexte -->
                <button class="carousel-control-prev d-none d-md-flex" 
                        type="button" 
                        data-bs-target="#evenements" 
                        data-bs-slide="prev" 
                        aria-label="Afficher le groupe d'événements précédent">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Précédent</span>
                </button>

                <button class="carousel-control-next d-none d-md-flex" 
                        type="button" 
                        data-bs-target="#evenements" 
                        data-bs-slide="next" 
                        aria-label="Afficher le groupe d'événements suivant">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Suivant</span>
                </button>
            {% endif %}
        </section>
    </div>

    <!-- ✅ Navigation de retour -->
    <nav class="bg-main w-100 py-3" role="navigation" aria-label="Navigation de retour">
        <div class="container text-center">
            {% if app.request.headers.get('Referer') %}
                <a href="{{ app.request.headers.get('Referer')|e('html_attr') }}" 
                   class="text text-decoration-underline"
                   aria-label="Retourner à la page précédente">
                    <i class="bi bi-arrow-left" aria-hidden="true"></i>
                    Retour à la page précédente
                </a>
            {% else %}
                <a href="{{ path('app_home') }}" 
                   class="text text-decoration-underline"
                   aria-label="Retourner à l'accueil">
                    <i class="bi bi-house" aria-hidden="true"></i>
                    Retour à l'accueil
                </a>
            {% endif %}
        </div>
    </nav>

</main>
{% endblock %}